name: CI

on:
  push:
    paths-ignore:
      - '.github/ISSUE_TEMPLATE/**'
      - '.github/PULL_REQUEST_TEMPLATE.md'
      - 'contrib/**'
      - 'docs/**'
      - 'netbox/translations/**'
  pull_request:
    paths-ignore:
      - '.github/ISSUE_TEMPLATE/**'
      - '.github/PULL_REQUEST_TEMPLATE.md'
      - 'contrib/**'
      - 'docs/**'
      - 'netbox/translations/**'

permissions:
  contents: read

# Add concurrency group to control job running
concurrency:
  group: ${{ github.event_name }}-${{ github.ref }}-${{ github.actor }}
  cancel-in-progress: true

jobs:
  build:
    runs-on: ubuntu-latest
    env:
      NETBOX_CONFIGURATION: netbox.configuration_testing
      DB_NAME: netbox
      DB_USER: netbox
      DB_PASSWORD: ${{ secrets.NETBOX_DB_PASSWORD }} 
      DB_HOST: localhost 
      DB_PORT: 5432
      PGUSER: netbox 
      POSTGRES_USER: netbox
      PGPASSWORD: ${{ secrets.NETBOX_DB_PASSWORD }}
      POSTGRES_HOST: localhost
      POSTGRES_PORT: 5432   
    strategy:
      matrix:
        python-version: ['3.10', '3.11', '3.12']
        node-version: ['20.x']
    services:
      redis:
        image: redis
        ports:
          - 6379:6379
      postgres:
        image: postgres:15
        env:
          POSTGRES_USER: netbox
          POSTGRES_PASSWORD: ${{ secrets.NETBOX_DB_PASSWORD }}
          POSTGRES_DB: netbox
        options: >-
          --health-cmd="pg_isready -U netbox -d netbox"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
          ports:
          - 5432:5432

    steps:
    - name: Check out repo
      uses: actions/checkout@v4

    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v5
      with:
        python-version: ${{ matrix.python-version }}

    - name: Wait for Postgres (pg_isready)
      env:
        PGPASSWORD: ${{ secrets.NETBOX_DB_PASSWORD }}
      run: |
        sudo apt-get update
        sudo apt-get install -y postgresql-client

        # 최대 150회, 2초 간격 => 최대 300초 대기
        for i in {1..150}; do
          if pg_isready -h localhost -p 5432 -U netbox >/dev/null 2>&1; then
            echo "Postgres ready"
            exit 0
          fi
          sleep 2
        done
        echo "Postgres did not become ready" >&2
        exit 1

    - name: Print Postgres logs for debugging
      if: failure()
      run: |
        echo "---- Postgres service containers ----"
        docker ps --filter ancestor=postgres --format 'ID: {{.ID}}  Image: {{.Image}}  Names: {{.Names}}' || true
        for id in $(docker ps --filter ancestor=postgres --format '{{.ID}}'); do
          echo "--- Logs for container: $id ---"
          docker logs $id || true
        done

    - name: Use Node.js ${{ matrix.node-version }}
      uses: actions/setup-node@v4
      with:
        node-version: ${{ matrix.node-version }}
    
    - name: Install Yarn Package Manager
      run: npm install -g yarn
    
    - name: Setup Node.js with Yarn Caching
      uses: actions/setup-node@v4
      with:
        node-version: ${{ matrix.node-version }}
        cache: yarn
        cache-dependency-path: netbox/project-static/yarn.lock
    
    - name: Install Frontend Dependencies
      run: yarn --cwd netbox/project-static

    - name: Install dependencies & set up configuration
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install ruff coverage tblib

    - name: Build documentation
      run: mkdocs build

    - name: Collect static files
      run: python netbox/manage.py collectstatic --no-input

    - name: Check for missing migrations
      run: python netbox/manage.py makemigrations --check

    - name: Check PEP8 compliance
      run: ruff check netbox/

    - name: Check UI ESLint, TypeScript, and Prettier Compliance
      run: yarn --cwd netbox/project-static validate
    
    - name: Validate Static Asset Integrity
      run: scripts/verify-bundles.sh

    - name: Run tests
      run: coverage run --source="netbox/" netbox/manage.py test netbox/ --parallel

    - name: Show coverage report
      run: coverage report --skip-covered --omit '*/migrations/*,*/tests/*'
