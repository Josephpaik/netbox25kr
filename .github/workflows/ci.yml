name: CI

on:
  push:
    paths-ignore:
      - '.github/ISSUE_TEMPLATE/**'
      - '.github/PULL_REQUEST_TEMPLATE.md'
      - 'contrib/**'
      - 'docs/**'
      - 'netbox/translations/**'
  pull_request:
    paths-ignore:
      - '.github/ISSUE_TEMPLATE/**'
      - '.github/PULL_REQUEST_TEMPLATE.md'
      - 'contrib/**'
      - 'docs/**'
      - 'netbox/translations/**'

permissions:
  contents: read

# Add concurrency group to control job running
concurrency:
  group: ${{ github.event_name }}-${{ github.ref }}-${{ github.actor }}
  cancel-in-progress: true

jobs:
  build:
    runs-on: ubuntu-latest
    env:
      NETBOX_CONFIGURATION: netbox.configuration_testing
      DB_NAME: netbox
      DB_USER: netbox
      DB_PASSWORD: ${{ secrets.NETBOX_DB_PASSWORD }} 
      DB_HOST: localhost 
      DB_PORT: 5432
      PGUSER: netbox 
      POSTGRES_USER: netbox
      PGPASSWORD: ${{ secrets.NETBOX_DB_PASSWORD }}
      POSTGRES_HOST: localhost
      POSTGRES_PORT: 5432   
    strategy:
      matrix:
        python-version: ['3.10', '3.11', '3.12']
        node-version: ['20.x']
    services:
      redis:
        image: redis
        ports:
          - 6379:6379
      postgres:
        image: postgres:15
        env:
          POSTGRES_USER: netbox
          POSTGRES_PASSWORD: ${{ secrets.NETBOX_DB_PASSWORD }}
          POSTGRES_DB: netbox
        options: >-
          --health-cmd="pg_isready -U netbox -d netbox"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

    steps:
    - name: Check out repo
      uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5  #v4
    
    # 로컬component-detection파일이 액션/툴을 가리지않게 사전(Pre) 스텝을 체크아웃 직후에 추가
    - name: Prevent local component-detection from shadowing the tool 20251122
      run: |
        if [ -f ./component-detection ]; then
          echo "Local ./component-detection found — moving to ./component-detection.bak to avoid shadowing."
          mv ./component-detection ./component-detection.bak || { echo "mv failed, attempting rm"; rm -f ./component-detection || true; }
          chmod -x ./component-detection.bak || true
          echo "Moved to ./component-detection.bak:"
          ls -la ./component-detection.bak || true
        else
          echo "No local ./component-detection file found."
        fi

    - name: Diagnostic - check for component-detection output (non-failing)
      if: always()
      run: |
        if [ -f ./output.json ]; then
          echo "output.json present (size=$(stat -c%s ./output.json) bytes)."
          head -c 10240 ./output.json || true
        else
          echo "No output.json found. This is okay unless you expect component-detection to run in this workflow."
          echo "Top-level files:"
          ls -la . || true
          test -f ./component-detection && echo "WARNING: ./component-detection exists (size=$(stat -c%s ./component-detection) bytes)" || true
          test -f ./component-detection.bak && echo "Found ./component-detection.bak (moved earlier)." || true
        fi
    
    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@a26af69be951a213d495a4c3e4e4022e16d87065  #v5
      with:
        python-version: ${{ matrix.python-version }}

    - name: Wait for Postgres (pg_isready)
      env:
        PGPASSWORD: ${{ secrets.NETBOX_DB_PASSWORD }}
      run: |
        sudo apt-get update
        sudo apt-get install -y postgresql-client

        # 최대 150회, 2초 간격 => 최대 300초 대기
        for i in {1..150}; do
          if pg_isready -h localhost -p 5432 -U netbox >/dev/null 2>&1; then
            echo "Postgres ready"
            exit 0
          fi
          sleep 2
        done
        echo "Postgres did not become ready" >&2
        exit 1

    - name: Print Postgres logs for debugging
      if: failure()
      run: |
        echo "---- Postgres service containers ----"
        docker ps --filter ancestor=postgres --format 'ID: {{.ID}}  Image: {{.Image}}  Names: {{.Names}}' || true
        for id in $(docker ps --filter ancestor=postgres --format '{{.ID}}'); do
          echo "--- Logs for container: $id ---"
          docker logs $id || true
        done

    - name: Use Node.js ${{ matrix.node-version }}
      uses: actions/setup-node@34e114876b0b11c390a56381ad16ebd13914f8d5  #v4
      with:
        node-version: ${{ matrix.node-version }}
    
    - name: Install Yarn Package Manager
      run: npm install -g yarn
    
    - name: Setup Node.js with Yarn Caching
      uses: actions/setup-node@34e114876b0b11c390a56381ad16ebd13914f8d5  #v4
      with:
        node-version: ${{ matrix.node-version }}
        cache: yarn
        cache-dependency-path: netbox/project-static/yarn.lock
    
    - name: Install Frontend Dependencies
      run: yarn --cwd netbox/project-static

    - name: Install dependencies & set up configuration
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install ruff coverage tblib

    - name: Build documentation
      run: mkdocs build

    - name: Collect static files
      run: python netbox/manage.py collectstatic --no-input

    - name: Check for missing migrations
      run: python netbox/manage.py makemigrations --check

    - name: Check PEP8 compliance
      run: ruff check netbox/

    - name: Check UI ESLint, TypeScript, and Prettier Compliance
      run: yarn --cwd netbox/project-static validate
    
    - name: Validate Static Asset Integrity
      run: scripts/verify-bundles.sh

    - name: Run tests
      run: coverage run --source="netbox/" netbox/manage.py test netbox/ --parallel

    - name: Show coverage report
      run: coverage report --skip-covered --omit '*/migrations/*,*/tests/*'
